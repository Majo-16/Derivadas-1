<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Derivadas Profesional</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.9/nerdamer.core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.9/Calculus.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      background: purple;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    h2 {
      color: purple;
    }
    canvas {
      margin-top: 20px;
    }
    pre {
      background: #eee;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Calculadora de Derivadas Profesional</h2>
    <input type="text" id="funcion" placeholder="Escribe la función, por ejemplo: 2x^2 + 3x">
    <button onclick="resolverDerivada()">Resolver</button>
    
    <h3>Resultado:</h3>
    <p><strong>Derivada:</strong> <span id="resultado"></span></p>
    
    <h3>Paso a paso:</h3>
    <pre id="pasos"></pre>

    <h3>Gráfico:</h3>
    <canvas id="grafico" width="700" height="400"></canvas>
  </div>

  <script>
    function insertarMultiplicaciones(str) {
      return str.replace(/(\d)([a-zA-Z])/g, '$1*$2')  // 2x -> 2*x
                .replace(/([a-zA-Z])(\d)/g, '$1*$2')  // x2 -> x*2
                .replace(/([a-zA-Z])([a-zA-Z])/g, '$1*$2'); // xsin -> x*sin
    }

    function resolverDerivada() {
      const entradaUsuario = document.getElementById('funcion').value;
      const entrada = insertarMultiplicaciones(entradaUsuario.replace(/\^/g, '**')); // para math.js
      const entradaParaNerdamer = insertarMultiplicaciones(entradaUsuario.replace(/\*\*/g, '^')); // para nerdamer

      try {
        // Calcular derivada
        const derivada = nerdamer(`diff(${entradaParaNerdamer}, x)`).toString();
        document.getElementById('resultado').innerText = derivada;

        // Paso a paso (simplificado)
        let pasos = `1. Función original: f(x) = ${entradaUsuario}\n`;
        pasos += `2. Aplicamos reglas de derivación\n`;
        pasos += `3. Resultado: f'(x) = ${derivada}`;
        document.getElementById('pasos').innerText = pasos;

        // Evaluar con math.js
        const f = math.evaluate(`f(x) = ${entrada}`);
        const f_deriv = math.evaluate(`f_deriv(x) = ${insertarMultiplicaciones(derivada.replace(/\^/g, '**'))}`);

        const x_vals = [];
        const y_vals_f = [];
        const y_vals_f_deriv = [];

        for (let x = -10; x <= 10; x += 0.5) {
          x_vals.push(x);
          y_vals_f.push(f(x));
          y_vals_f_deriv.push(f_deriv(x));
        }

        const ctx = document.getElementById('grafico').getContext('2d');
        if (window.myChart) window.myChart.destroy();

        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: x_vals,
            datasets: [
              {
                label: 'f(x)',
                data: y_vals_f,
                borderColor: 'blue',
                fill: false
              },
              {
                label: "f'(x)",
                data: y_vals_f_deriv,
                borderColor: 'purple',
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              },
              title: {
                display: true,
                text: 'Función y su Derivada'
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'x'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'y'
                }
              }
            }
          }
        });

      } catch (error) {
        document.getElementById('resultado').innerText = 'Error al calcular. Revisa la función.';
        document.getElementById('pasos').innerText = '';
      }
    }
  </script>
</body>
</html>
